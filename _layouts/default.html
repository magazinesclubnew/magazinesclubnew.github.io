<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="view-transition" content="same-origin">
  <meta name="theme-color" id="theme-color-meta" content="#fafafa">
  <link rel="icon" type="image/png" href="{{ '/assets/images/favicon.png' | relative_url }}">
  <link rel="apple-touch-icon" href="{{ '/assets/images/favicon.png' | relative_url }}">
  {% seo %}

  <!-- Fonts: Noto Serif SC (body) + IBM Plex Mono (code/dates) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500&family=Noto+Serif+SC:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- KaTeX for Math -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"
    onload="renderMathInElement(document.body, {
      delimiters: [
        {left: '$$', right: '$$', display: true},
        {left: '\\[', right: '\\]', display: true},
        {left: '$', right: '$', display: false},
        {left: '\\(', right: '\\)', display: false}
      ]
    });"></script>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      corePlugins: { preflight: false },
      theme: {
        extend: {
          colors: {
            bg: 'var(--color-bg)',
            surface: 'var(--color-surface)',
            text: {
              DEFAULT: 'var(--color-text)',
              secondary: 'var(--color-text-secondary)',
              tertiary: 'var(--color-text-tertiary)',
            },
            accent: {
              DEFAULT: 'var(--color-accent)',
              hover: 'var(--color-accent-hover)',
            },
            border: {
              DEFAULT: 'var(--color-border)',
              light: 'var(--color-border-light)',
            },
          }
        }
      }
    }
  </script>
  <script>
    // Dark mode initialization (before page renders to avoid flash)
    (function() {
      const saved = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      const isDark = saved === 'dark' || (saved === 'system' && prefersDark) || (!saved && prefersDark);
      if (isDark) {
        document.documentElement.classList.add('dark');
        document.getElementById('theme-color-meta').content = '#161616';
      }
    })();
  </script>

  <link rel="stylesheet" href="{{ '/assets/css/main.css' | relative_url }}">
  {% feed_meta %}


  <!-- Cookie Consent & Analytics -->
  <script>
    function loadClarity() {
      (function(c,l,a,r,i,t,y){
        c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
        t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
        y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
      })(window, document, "clarity", "script", "v6h4142fqg");
    }

    function acceptCookies() {
      localStorage.setItem('cookie-consent', 'accepted');
      document.getElementById('cookie-banner').style.display = 'none';
      loadClarity();
    }

    function rejectCookies() {
      localStorage.setItem('cookie-consent', 'rejected');
      document.getElementById('cookie-banner').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', function() {
      var consent = localStorage.getItem('cookie-consent');
      if (consent === 'accepted') {
        loadClarity();
      } else if (consent !== 'rejected') {
        document.getElementById('cookie-banner').style.display = 'flex';
      }
    });
  </script>
</head>
<body>
  <!-- GDPR Cookie Banner -->
  <div id="cookie-banner" class="cookie-banner" style="display: none;">
    <p>本站使用 Cookie 和分析工具来改善用户体验。继续浏览即表示您同意我们的 <a href="{{ '/privacy' | relative_url }}">隐私政策</a>。</p>
    <div class="cookie-buttons">
      <button onclick="acceptCookies()" class="cookie-accept">接受</button>
      <button onclick="rejectCookies()" class="cookie-reject">拒绝</button>
    </div>
  </div>
  <header class="site-header">
    <nav class="nav">
      <a href="{{ '/' | relative_url }}" class="nav-title">{{ site.title }}</a>
      <div class="nav-links">
        <a href="{{ '/' | relative_url }}" class="nav-link-icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="18" height="18">
            <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
          </svg>
          <span>首页</span>
        </a>
        <a href="{{ '/search' | relative_url }}" class="nav-link-icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="18" height="18">
            <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
          </svg>
          <span>搜索</span>
        </a>
        <a href="{{ '/about' | relative_url }}" class="nav-link-icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="18" height="18">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" />
          </svg>
          <span>关于</span>
        </a>
        <a href="{{ '/feed.xml' | relative_url }}" class="nav-link-icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" width="18" height="18">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12.75 19.5v-.75a7.5 7.5 0 0 0-7.5-7.5H4.5m0-6.75h.75c7.87 0 14.25 6.38 14.25 14.25v.75M6 18.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0Z" />
          </svg>
          <span>RSS</span>
        </a>
        <div class="theme-toggle">
          <div class="theme-toggle__track" role="group" aria-label="主题切换">
            <span class="theme-toggle__indicator"></span>
            <button data-theme="system" class="theme-toggle__btn active" aria-pressed="true" title="跟随系统">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect width="18" height="12" x="3" y="4" rx="2"/><line x1="8" x2="16" y1="20" y2="20"/><line x1="12" x2="12" y1="16" y2="20"/>
              </svg>
            </button>
            <button data-theme="light" class="theme-toggle__btn" aria-pressed="false" title="浅色模式">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="4"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/>
              </svg>
            </button>
            <button data-theme="dark" class="theme-toggle__btn" aria-pressed="false" title="深色模式">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <main class="main">
    {{ content }}
  </main>

  <footer class="site-footer">
    <div class="footer-content">
      <p>&copy; {{ site.time | date: '%Y' }} {{ site.author }}</p>
    </div>
  </footer>

  <script>
    (function() {
      const toggle = document.querySelector('.theme-toggle');
      const track = toggle.querySelector('.theme-toggle__track');
      const buttons = toggle.querySelectorAll('.theme-toggle__btn');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
      const themeOrder = ['system', 'light', 'dark'];

      function applyTheme(theme) {
        const html = document.documentElement;
        const themeColorMeta = document.getElementById('theme-color-meta');
        let isDark = false;

        if (theme === 'dark') {
          html.classList.add('dark');
          isDark = true;
        } else if (theme === 'light') {
          html.classList.remove('dark');
          isDark = false;
        } else {
          if (prefersDark.matches) {
            html.classList.add('dark');
            isDark = true;
          } else {
            html.classList.remove('dark');
            isDark = false;
          }
        }

        // Update browser theme-color
        if (themeColorMeta) {
          themeColorMeta.content = isDark ? '#161616' : '#fafafa';
        }
      }

      function setActiveButton(theme) {
        const index = Math.max(0, themeOrder.indexOf(theme));
        track.style.setProperty('--theme-index', index);
        buttons.forEach(btn => {
          const isActive = btn.dataset.theme === theme;
          btn.classList.toggle('active', isActive);
          btn.setAttribute('aria-pressed', isActive);
        });
      }

      function switchTheme(theme, event) {
        const doSwitch = () => {
          localStorage.setItem('theme', theme);
          setActiveButton(theme);
          applyTheme(theme);
        };

        // Use View Transitions API with circular clip-path animation
        if (document.startViewTransition && !window.matchMedia('(prefers-reduced-motion: reduce)').matches && event) {
          // Get button position for circle origin
          const btn = event.currentTarget;
          const rect = btn.getBoundingClientRect();
          const x = rect.left + rect.width / 2;
          const y = rect.top + rect.height / 2;

          // Calculate radius needed to cover entire screen
          const maxX = Math.max(x, window.innerWidth - x);
          const maxY = Math.max(y, window.innerHeight - y);
          const radius = Math.sqrt(maxX * maxX + maxY * maxY);

          // Set CSS custom properties for the animation
          document.documentElement.style.setProperty('--theme-toggle-x', x + 'px');
          document.documentElement.style.setProperty('--theme-toggle-y', y + 'px');
          document.documentElement.style.setProperty('--theme-toggle-radius', radius + 'px');

          // Mark as theme transition for CSS targeting
          document.documentElement.classList.add('theme-transitioning');
          const transition = document.startViewTransition(doSwitch);
          transition.finished.then(() => {
            document.documentElement.classList.remove('theme-transitioning');
          });
        } else {
          doSwitch();
        }
      }

      // Initialize from saved theme
      const saved = localStorage.getItem('theme') || 'system';
      setActiveButton(saved);

      // Handle button clicks
      buttons.forEach(btn => {
        btn.addEventListener('click', function(e) {
          switchTheme(this.dataset.theme, e);
        });
      });

      // Listen for system theme changes
      prefersDark.addEventListener('change', function() {
        const current = localStorage.getItem('theme') || 'system';
        if (current === 'system') {
          applyTheme('system');
        }
      });

      // Initial theme-color update
      applyTheme(saved);
    })();
  </script>

</body>
</html>
